<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realitylab Bimodales Netzwerk</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // Icon Helper Component
        const Icon = ({ name, size = 20, className = "" }) => {
            const [iconSvg, setIconSvg] = useState("");
            useEffect(() => {
                if (window.lucide) {
                    const svg = window.lucide.createIcons();
                }
            }, []);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        // --- DATA & LOGIC (Identisch zu deiner funktionierenden Version) ---
        const orgMetadata = {
            "Arteria Technologies FlexCo": { url: "www.arteria.at", logo: "https://www.arteria-tech.com/assets/svg/logos/arteria_brand.svg" },
            "baukult ZT GmbH": { url: "www.baukult.at", logo: "https://baukult.at/favicon.ico" },
            "CEAS GmbH": { url: "www.ceas.at", logo: null },
            "Die HausWirtschaft e.Gen.": { url: "www.diehauswirtschaft.at", logo: "https://diehauswirtschaft.at/wp-content/uploads/2022/04/dieHausWirtschaft-Lockup-cropped-hoch_Logo-dunkelblau.png" },
            "e7 GmbH": { url: "www.e-sieben.at", logo: "https://www.e-sieben.at/includes/images/e7-logo.svg?m=1704730217" },
            "ed-energiedigital GmbH": { url: "https://www.energiedigital.at/", logo: "https://www.energiedigital.at/img/logo/dark.png" },
            "EGW Erste gemeinnützige Wohnungsgesellschaft mbH": { url: "www.egw.at", logo: "https://www.egw.at/favicon.ico" },
            "einszueins architektur ZT GMBH": { url: "www.einszueins.at", logo: "https://www.einszueins.at/favicon.ico" },
            "Ernst RAINER - Büro für resiliente Raum- und Stadtentwicklung e.U.": { url: "www.ernst-rainer.at", logo: "https://www.ernst-rainer.at/favicon.ico" },
            "Fachhochschule Technikum Wien": { url: "www.technikum-wien.at", logo: "https://www.technikum-wien.at/favicon.ico" },
            "Gartenheim Genossenschaft": { url: "www.gartenheim.at", logo: "https://www.gartenheim.at/favicon.ico" },
            "GSG Altmannsdorf und Hetzendorf reg. Gen. m. b. H.": { url: "www.ah-wohnen.at", logo: "https://ah-wohnen.at/favicon.ico" },
            "GrünStattGrau Forschungs- und Innovations-GmbH": { url: "www.gruenstattgrau.at", logo: "https://gruenstattgrau.at/wp-content/uploads/2024/02/cropped-cropped-gruenstattgrau_logo_square_rgb_300dpi-1.jpg" },
            "grünplan gmbh": { url: "www.gruenplan.at", logo: "https://www.gruenplan.at/favicon.ico" },
            "Initiative Gemeinsam Bauen und Wohnen": { url: "www.inigbw.org", logo: "https://www.inigbw.org/favicon.ico" },
            "KELAG Energie & Wärme GmbH": { url: "www.kew.at", logo: "https://www.kew.at/favicon.ico" },
            "Landeskrankenanstalten-Betriebsgesellschaft-KABEG": { url: "www.kabeg.at", logo: "https://www.kabeg.at/_assets/ce9a94c4a023abc6a288e39e1b7f94b3/Images/Logo.svg" },
            "M2S Rechtsanwälte GmbH": { url: "www.m2s.at", logo: "https://www.m2s.at/favicon.ico" },
            "nonconform zt gmbh": { url: "www.nonconform.at", logo: "https://www.nonconform.at/favicon.ico" },
            "Pink GmbH": { url: "www.pink.co.at", logo: "https://www.pink.co.at/favicon.ico" },
            "realitylab GmbH": { url: "www.realitylab.at", logo: "http://rl.wp.anton.realitylab.at/wp-content/uploads/sites/26/2026/01/Brandmark_realitylab_rgb_black_m_mit_rand.png" },
            "REENAG Holding GmbH": { url: "www.reenag.com", logo: "https://www.reenag.com/themes/reenag/reenag.png" },
            "SOZIALBAU AG": { url: "www.sozialbau.at", logo: "https://www.sozialbau.at/fileadmin/favicon.png" },
            "STC Development GmbH": { url: "www.stc-dev.com", logo: "https://www.stc-dev.com/favicon.ico" },
            "Technische Universität Wien": { url: "www.tuwien.ac.at", logo: "https://www.tuwien.at/favicon.ico" },
            "TPA Steuerberatung GmbH": { url: "www.tpa-group.at", logo: "https://www.tpa-group.at/app/uploads/2023/11/TPA_Logo_Druck_rgb.jpg" },
            "Universität für Bodenkultur Wien": { url: "www.boku.ac.at", logo: "https://boku.ac.at/favicon.ico" },
            "Verein zur Förderung der Klimaneutralität im Kahlenbergerdörfl": { url: "www.klimadoerfl.at", logo: null },
            "VKFG Villacher Klimafit GmbH": { url: "www.villach.at", logo: "https://villach.at/favicon.ico" },
            "Volkshilfe Wien": { url: "www.volkshilfe-wien.at", logo: "https://t0.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=http://www.volkshilfe-wien.at" }
        };

        const projectMetadata = {
            "OPENhauswirtschaft": { website: "https://projekte.ffg.at/projekt/3226093", logo: "https://diehauswirtschaft.at/wp-content/uploads/2022/04/dieHausWirtschaft-Lockup-cropped-hoch_Logo-dunkelblau-768x371.png" },
            "lieBeKlima": { website: "https://projekte.ffg.at/projekt/4227276", logo: "https://rl.wp.anton.realitylab.at/wp-content/uploads/sites/26/2025/12/Bild-300x252.png" },
            "DieWärmePioniere": { website: "https://projekte.ffg.at/projekt/4425009", logo: "http://rl.wp.anton.realitylab.at/wp-content/uploads/sites/26/2026/01/Ohne-Titel-8-scaled.png" },
            "Citizens4PED": { website: "https://citizens4ped.eu/", logo: "http://rl.wp.anton.realitylab.at/wp-content/uploads/sites/26/2026/01/c4p.png" },
            "DekarboGen": { website: "https://projekte.ffg.at/projekt/4672920", logo: "https://rl.wp.anton.realitylab.at/wp-content/uploads/sites/26/2025/05/LOGO_1-300x83.png" },
            "#EEG++": { website: "https://projekte.ffg.at/projekt/4762052", logo: "http://rl.wp.anton.realitylab.at/wp-content/uploads/sites/26/2026/01/eeg-scaled.png" },
            "ZxB": { website: "https://zxb-info.at/", logo: "https://rl.wp.anton.realitylab.at/wp-content/uploads/sites/26/2025/12/ZxB_Logo_230729-300x238.png" },
            "HeatCOOP": { website: "https://blog.gemeinschaffen.com/2024/11/25/heatcoop-2/", logo: "https://rl.wp.anton.realitylab.at/wp-content/uploads/sites/26/2025/05/HeatCoop_Logo-300x61.png" },
            "ZplusB": { website: "https://projekte.ffg.at/projekt/5135931", logo: "https://rl.wp.anton.realitylab.at/wp-content/uploads/sites/26/2025/05/ZB_Logo_250113-300x200.png" },
            "Siedler:innen": { website: "https://projekte.ffg.at/projekt/5140203", logo: "https://rl.wp.anton.realitylab.at/wp-content/uploads/sites/26/2026/01/dieSiedlerinnen-scaled.png" },
            "Coop4PEDS": { website: "https://projekte.ffg.at/projekt/5143182", logo: "http://rl.wp.anton.realitylab.at/wp-content/uploads/sites/26/2025/12/Coop4PEDs_LOGO-scaled.png" },
            "SchrittZuKlimafit": { website: "https://projekte.ffg.at/projekt/5145349", logo: "http://rl.wp.anton.realitylab.at/wp-content/uploads/sites/26/2026/01/dieSiedlerinnen-scaled.png" },
            "PED StepWise": { website: "https://projekte.ffg.at/projekt/4869320", logo: "https://pedstepwise.wp.anton.realitylab.at/wp-content/uploads/sites/46/2024/07/PED-StepWise-Logo-300x50.png" }
        };

        const rawData = [
            { id: "3226093", title: "OPENhauswirtschaft", org: "Technische Universität Wien", role: "Konsortialführer", abstract: "Innovatives Hauswirtschaften im nutzungsgemischten Stadtkern...", period: "2019 - 2022", keywords: "Nutzungsmischung; Erdgeschosszone; kooperative Stadtentwicklung", program: "Stadt der Zukunft", call: "5. Ausschreibung" },
            { id: "3226093", title: "OPENhauswirtschaft", org: "Die HausWirtschaft e.Gen.", role: "Konsortialpartner" },
            { id: "3226093", title: "OPENhauswirtschaft", org: "EGW Erste gemeinnützige Wohnungsgesellschaft mbH", role: "Konsortialpartner" },
            { id: "3226093", title: "OPENhauswirtschaft", org: "einszueins architektur ZT GMBH", role: "Konsortialpartner" },
            { id: "3226093", title: "OPENhauswirtschaft", org: "realitylab GmbH", role: "Konsortialpartner" },
            { id: "4227276", title: "lieBeKlima", org: "STC Development GmbH", role: "Konsortialführer", abstract: "Qualitätssicherung der liegenschafts-übergreifenden Begrünung...", period: "2022 - 2022", keywords: "Begrünung; Klimaanpassung", program: "Stadt der Zukunft", call: "8. Ausschreibung" },
            { id: "4227276", title: "lieBeKlima", org: "GrünStattGrau Forschungs- und Innovations-GmbH", role: "Konsortialpartner" },
            { id: "4227276", title: "lieBeKlima", org: "Universität für Bodenkultur Wien", role: "Konsortialpartner" },
            { id: "4227276", title: "lieBeKlima", org: "e7 GmbH", role: "Konsortialpartner" },
            { id: "4227276", title: "lieBeKlima", org: "grünplan gmbh", role: "Konsortialpartner" },
            { id: "4227276", title: "lieBeKlima", org: "realitylab GmbH", role: "Konsortialpartner" },
            { id: "4425009", title: "DieWärmePioniere", org: "e7 GmbH", role: "Konsortialführer", abstract: "Partizipativer Klima-Transformationsfahrplan Kahlenbergerdorf...", period: "2022 - 2023", keywords: "Wärmewende; Bürgerbeteiligung", program: "Stadt der Zukunft", call: "Themenausschreibung 2021" },
            { id: "4425009", title: "DieWärmePioniere", org: "Verein zur Förderung der Klimaneutralität im Kahlenbergerdörfl", role: "Konsortialpartner" },
            { id: "4425009", title: "DieWärmePioniere", org: "realitylab GmbH", role: "Konsortialpartner" },
            { id: "4459629", title: "Citizens4PED", org: "e7 GmbH", role: "Konsortialführer", abstract: "Citizen-inclusive PEDs in existing urban areas...", period: "2022 - 2025", keywords: "PED; Positive Energy District", program: "JPI Urban Europe", call: "Positive Energy Districts 2021" },
            { id: "4459629", title: "Citizens4PED", org: "Arteria Technologies FlexCo", role: "Konsortialpartner" },
            { id: "4459629", title: "Citizens4PED", org: "Fachhochschule Technikum Wien", role: "Konsortialpartner" },
            { id: "4459629", title: "Citizens4PED", org: "realitylab GmbH", role: "Konsortialpartner" },
            { id: "4672920", title: "DekarboGen", org: "e7 GmbH", role: "Konsortialführer", abstract: "Wärmewende-Genossenschaften...", period: "2023 - 2026", keywords: "Genossenschaften; Wärmewende", program: "Stadt der Zukunft", call: "Themenausschreibung 2022" },
            { id: "4672920", title: "DekarboGen", org: "Gartenheim Genossenschaft", role: "Konsortialpartner" },
            { id: "4672920", title: "DekarboGen", org: "REENAG Holding GmbH", role: "Konsortialpartner" },
            { id: "4672920", title: "DekarboGen", org: "SOZIALBAU AG", role: "Konsortialpartner" },
            { id: "4672920", title: "DekarboGen", org: "realitylab GmbH", role: "Konsortialpartner" },
            { id: "4762052", title: "#EEG++", org: "Arteria Technologies FlexCo", role: "Konsortialführer", abstract: "Digitale Plus-Energiegemeinschaften Optimiert...", period: "2023 - 2025", keywords: "Energiegemeinschaft; Digitalisierung", program: "Energieforschung", call: "Ausschreibung 2022" },
            { id: "4762052", title: "#EEG++", org: "CEAS GmbH", role: "Konsortialpartner" },
            { id: "4762052", title: "#EEG++", org: "Pink GmbH", role: "Konsortialpartner" },
            { id: "4762052", title: "#EEG++", org: "ed-energiedigital GmbH", role: "Konsortialpartner" },
            { id: "4762052", title: "#EEG++", org: "realitylab GmbH", role: "Konsortialpartner" },
            { id: "4821201", title: "ZxB", org: "realitylab GmbH", role: "Konsortialführer", abstract: "Zinshaus X Baugruppe...", period: "2023 - 2026", keywords: "Zinshaus; Baugruppe", program: "Stadt der Zukunft", call: "Themenausschreibung 2022" },
            { id: "4821201", title: "ZxB", org: "Initiative Gemeinsam Bauen und Wohnen", role: "Konsortialpartner" },
            { id: "4821201", title: "ZxB", org: "e7 GmbH", role: "Konsortialpartner" },
            { id: "4821201", title: "ZxB", org: "baukult ZT GmbH", role: "Konsortialpartner" },
            { id: "4869321", title: "HeatCOOP", org: "realitylab GmbH", role: "Konsortialführer", abstract: "Residents Owned Heat Cooperatives...", period: "2023 - 2026", keywords: "Heat Cooperatives; Dekarbonisierung", program: "ERA-Net SES", call: "Joint Call 2022" },
            { id: "4869321", title: "HeatCOOP", org: "REENAG Holding GmbH", role: "Konsortialpartner" },
            { id: "4869321", title: "HeatCOOP", org: "e7 GmbH", role: "Konsortialpartner" },
            { id: "5135931", title: "ZplusB", org: "realitylab GmbH", role: "Konsortialführer", abstract: "Baugruppenquartier Graz...", period: "2024 - 2025", keywords: "Baugruppe; Graz", program: "Stadt der Zukunft", call: "Ausschreibung 2023" },
            { id: "5135931", title: "ZplusB", org: "M2S Rechtsanwälte GmbH", role: "Konsortialpartner" },
            { id: "5135931", title: "ZplusB", org: "e7 GmbH", role: "Konsortialpartner" },
            { id: "5140203", title: "Siedler:innen", org: "realitylab GmbH", role: "Konsortialführer", abstract: "Lokale Wärme Gemeinsam...", period: "2025 - 2026", keywords: "Wärmewende; Partizipation", program: "Klima- und Energiefonds", call: "Leuchttürme der Wärmewende 2024" },
            { id: "5140203", title: "Siedler:innen", org: "Gartenheim Genossenschaft", role: "Konsortialpartner" },
            { id: "5140203", title: "Siedler:innen", org: "nonconform zt gmbh", role: "Konsortialpartner" },
            { id: "5140203", title: "Siedler:innen", org: "e7 GmbH", role: "Konsortialpartner" },
            { id: "5143182", title: "Coop4PEDS", org: "realitylab GmbH", role: "Konsortialführer", abstract: "Cooperatives as drivers of urban energy strategies...", period: "2025 - 2028", keywords: "Genossenschaften; PED", program: "DUT", call: "Call 2023" },
            { id: "5143182", title: "Coop4PEDS", org: "Volkshilfe Wien", role: "Konsortialpartner" },
            { id: "5143182", title: "Coop4PEDS", org: "e7 GmbH", role: "Konsortialpartner" },
            { id: "5145349", title: "SchrittZuKlimafit", org: "e7 GmbH", role: "Konsortialführer", abstract: "Nachverdichtung als Chance...", period: "2025 - 2026", keywords: "Anergienetz; Nachverdichtung", program: "Klima- und Energiefonds", call: "Leuchttürme der Wärmewende 2024" },
            { id: "5145349", title: "SchrittZuKlimafit", org: "Gartenheim Genossenschaft", role: "Konsortialpartner" },
            { id: "5145349", title: "SchrittZuKlimafit", org: "realitylab GmbH", role: "Konsortialpartner" },
            { id: "4869320", title: "PED StepWise", org: "e7 GmbH", role: "Konsortialführer", abstract: "Participatory step-by-step implementation process map...", period: "2023 - 2026", keywords: "renewable energy; PED", program: "DUT", call: "Ausschreibung 2022" },
            { id: "4869320", title: "PED StepWise", org: "Arteria Technologies FlexCo", role: "Konsortialpartner" },
            { id: "4869320", title: "PED StepWise", org: "realitylab GmbH", role: "Konsortialpartner" }
        ];

        const processData = () => {
            const nodesMap = {};
            const links = [];
            rawData.forEach(row => {
                const pKey = `proj_${row.title}`;
                const isRealitylabLead = rawData.some(r => r.title === row.title && r.org === "realitylab GmbH" && r.role === "Konsortialführer");
                if (!nodesMap[pKey]) {
                    const pMeta = projectMetadata[row.title] || {};
                    nodesMap[pKey] = { 
                        id: pKey, name: row.title, type: 'project', 
                        abstract: row.abstract, period: row.period,
                        keywords: row.keywords, program: row.program,
                        call: row.call, isLead: isRealitylabLead,
                        logo: pMeta.logo || null,
                        url: pMeta.website || null
                    };
                }
                let orgName = row.org;
                if (orgName.includes("Gartenheim")) orgName = "Gartenheim Genossenschaft";
                if (orgName.includes("SOZIALBAU")) orgName = "SOZIALBAU AG";
                const oKey = `org_${orgName}`;
                if (!nodesMap[oKey]) {
                    const meta = orgMetadata[row.org] || orgMetadata[orgName] || {};
                    nodesMap[oKey] = { 
                        id: oKey, name: row.org, type: 'org',
                        logo: meta.logo || null,
                        url: meta.url || null
                    };
                }
                links.push({ source: oKey, target: pKey, role: row.role });
            });
            return { nodes: Object.values(nodesMap), links };
        };

        const { nodes: processedNodes, links: processedLinks } = processData();

        function App() {
            const [nodes, setNodes] = useState(processedNodes.map(n => ({ 
                ...n, 
                x: Math.random() * 800 + 100, 
                y: Math.random() * 600 + 100, 
                vx: 0, 
                vy: 0 
            })));
            const [selectedNode, setSelectedNode] = useState(null);
            const [dragNodeId, setDragNodeId] = useState(null);
            const [isLegendExpanded, setIsLegendExpanded] = useState(true);
            const svgRef = useRef(null);
            const requestRef = useRef();

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [selectedNode, isLegendExpanded]);

            const updatePhysics = useCallback(() => {
                setNodes(prev => {
                    const next = prev.map(n => ({ ...n }));
                    const width = svgRef.current?.clientWidth || 1000;
                    const height = svgRef.current?.clientHeight || 800;
                    const centerY = isLegendExpanded ? height / 2 : height * 0.45;

                    for (let i = 0; i < next.length; i++) {
                        for (let j = i + 1; j < next.length; j++) {
                            const a = next[i], b = next[j];
                            let dx = a.x - b.x, dy = a.y - b.y;
                            let d2 = dx * dx + dy * dy || 1;
                            let force = 4000 / d2;
                            if (a.id !== dragNodeId) { a.vx += (dx / Math.sqrt(d2)) * force; a.vy += (dy / Math.sqrt(d2)) * force; }
                            if (b.id !== dragNodeId) { b.vx -= (dx / Math.sqrt(d2)) * force; b.vy -= (dy / Math.sqrt(d2)) * force; }
                        }
                    }

                    processedLinks.forEach(l => {
                        const s = next.find(n => n.id === l.source), t = next.find(n => n.id === l.target);
                        if (s && t) {
                            let dx = t.x - s.x, dy = t.y - s.y;
                            let dist = Math.sqrt(dx * dx + dy * dy) || 1;
                            let force = (dist - 150) * 0.04;
                            if (s.id !== dragNodeId) { s.vx += (dx / dist) * force; s.vy += (dy / dist) * force; }
                            if (t.id !== dragNodeId) { t.vx -= (dx / dist) * force; t.vy -= (dy / dist) * force; }
                        }
                    });

                    next.forEach(n => {
                        if (n.id === dragNodeId) return;
                        n.vx += (width / 2 - n.x) * 0.005;
                        n.vy += (centerY - n.y) * 0.005;
                        n.x += n.vx; n.y += n.vy;
                        n.vx *= 0.6; n.vy *= 0.6;
                    });
                    return next;
                });
                requestRef.current = requestAnimationFrame(updatePhysics);
            }, [dragNodeId, isLegendExpanded]);

            useEffect(() => {
                requestRef.current = requestAnimationFrame(updatePhysics);
                return () => cancelAnimationFrame(requestRef.current);
            }, [updatePhysics]);

            return (
                <div className="flex flex-col h-screen bg-slate-50 overflow-hidden font-sans text-slate-900">
                    <header className="bg-slate-900 text-white p-4 flex justify-between items-center shadow-lg z-20 shrink-0">
                        <div className="flex items-center gap-3 font-bold">
                            <Icon name="layers" className="text-emerald-400" />
                            <span className="tracking-tight uppercase text-lg">realitylab - Forschungsnetzwerk</span>
                        </div>
                    </header>

                    <div className="flex-1 relative flex overflow-hidden">
                        <div className="absolute top-4 left-4 z-10 max-w-sm">
                            <div className="bg-white/95 backdrop-blur shadow-xl border border-slate-200 rounded-2xl overflow-hidden transition-all duration-300">
                                <div className="flex items-center justify-between p-4 cursor-pointer hover:bg-slate-50 border-b border-transparent" onClick={() => setIsLegendExpanded(!isLegendExpanded)}>
                                    <div className="flex items-center gap-2">
                                        <Icon name="info" className="text-indigo-600" />
                                        <span className="font-bold text-sm text-slate-900">Informationen</span>
                                    </div>
                                    {isLegendExpanded ? <Icon name="chevron-up" /> : <Icon name="chevron-down" />}
                                </div>
                                <div className={`transition-all duration-300 overflow-hidden ${isLegendExpanded ? 'max-h-[500px] opacity-100 p-5 pt-0' : 'max-h-0 opacity-0'}`}>
                                    <div className="text-xs leading-relaxed text-slate-600">
                                        <p className="font-bold text-slate-900 mb-2 underline decoration-indigo-200">Worum geht es hier?</p>
                                        Dieses interaktive Netzwerkdiagramm zeigt alle Forschungsprojekte der letzten 5 Jahre, an denen realitylab beteiligt war.
                                        <div className="mt-3 flex flex-col gap-2">
                                            <div className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-blue-100 border border-blue-500"></span><span>Partner sind Kreise</span></div>
                                            <div className="flex items-center gap-2"><span className="w-3 h-3 rounded bg-emerald-100 border border-emerald-500"></span><span>Projekte sind Quadrate</span></div>
                                            <div className="flex items-center gap-2"><span className="w-3 h-3 rounded bg-emerald-900 border-2 border-emerald-600"></span><span>Wir als Konsortialführer</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <main className="flex-1 bg-white relative">
                            <svg ref={svgRef} className="w-full h-full cursor-grab active:cursor-grabbing" 
                                 onMouseMove={e => {
                                     if (dragNodeId) {
                                         const rect = svgRef.current.getBoundingClientRect();
                                         setNodes(prev => prev.map(n => n.id === dragNodeId ? { ...n, x: e.clientX - rect.left, y: e.clientY - rect.top, vx: 0, vy: 0 } : n));
                                     }
                                 }}
                                 onMouseUp={() => setDragNodeId(null)}
                                 onMouseLeave={() => setDragNodeId(null)}>
                                <defs>
                                    {nodes.map(n => {
                                        if (!n.logo) return null;
                                        const safeId = n.id.replace(/[^a-zA-Z0-9]/g, '');
                                        return (
                                            <pattern key={`pattern-${n.id}`} id={`logo-${safeId}`} patternUnits="objectBoundingBox" width="1" height="1">
                                                <rect width="60" height="60" fill="white" />
                                                <image href={n.logo} x="5" y="5" width="50" height="50" preserveAspectRatio="xMidYMid meet" />
                                            </pattern>
                                        );
                                    })}
                                </defs>
                                {processedLinks.map((l, i) => {
                                    const s = nodes.find(n => n.id === l.source), t = nodes.find(n => n.id === l.target);
                                    if (!s || !t) return null;
                                    return <line key={i} x1={s.x} y1={s.y} x2={t.x} y2={t.y} stroke={l.role === "Konsortialführer" ? "#6366f1" : "#cbd5e1"} strokeWidth={l.role === "Konsortialführer" ? 2.5 : 1} className="transition-all duration-300 opacity-40" />;
                                })}
                                {nodes.map(n => {
                                    const isRL = n.name.toLowerCase().includes("realitylab");
                                    const safeId = n.id.replace(/[^a-zA-Z0-9]/g, '');
                                    const initials = n.name.split(/[\s-]+/).map(w => w[0]).join('').substring(0,2).toUpperCase();
                                    return (
                                        <g key={n.id} transform={`translate(${n.x},${n.y})`} onMouseDown={(e) => { e.stopPropagation(); setDragNodeId(n.id); setSelectedNode(n); }} className="cursor-pointer group">
                                            {n.type === 'project' ? (
                                                <rect x="-30" y="-30" width="60" height="60" rx="12" fill={n.logo ? `url(#logo-${safeId})` : (n.isLead ? "#064e3b" : "#dcfce7")} stroke={n.isLead ? "#059669" : "#10b981"} strokeWidth={n.isLead ? "4" : "2.5"} className="shadow-md hover:scale-110 transition-transform duration-200" />
                                            ) : (
                                                <g className="hover:scale-110 transition-transform duration-200">
                                                    <circle r="30" fill={n.logo ? `url(#logo-${safeId})` : (isRL ? "#dc2626" : "#eff6ff")} stroke={isRL ? "#dc2626" : "#3b82f6"} strokeWidth={isRL ? "3" : "2.5"} className="shadow-md" />
                                                    {!n.logo && <text textAnchor="middle" dy="5" className={`${isRL ? 'fill-white' : 'fill-blue-600'} font-black text-xs select-none pointer-events-none`}>{isRL ? "RL" : initials}</text>}
                                                </g>
                                            )}
                                            <text dy="45" textAnchor="middle" className="text-[10px] font-bold fill-slate-600 select-none pointer-events-none drop-shadow-sm">{n.name.length > 20 ? n.name.substring(0, 18) + ".." : n.name}</text>
                                        </g>
                                    );
                                })}
                            </svg>
                        </main>

                        {selectedNode && (
                            <aside className="w-80 md:w-[450px] bg-white border-l shadow-2xl z-30 flex flex-col h-full overflow-hidden">
                                <div className="flex-1 overflow-y-auto p-8 custom-scrollbar">
                                    <button onClick={() => setSelectedNode(null)} className="float-right p-2 hover:bg-slate-100 rounded-full"><Icon name="x" size={20}/></button>
                                    <div className="flex flex-col gap-6 mb-8 pt-4">
                                        {selectedNode.logo ? (
                                            <div className="w-full flex justify-center bg-slate-50 p-6 rounded-2xl border border-dashed border-slate-200"><img src={selectedNode.logo} alt={selectedNode.name} className="max-h-32 object-contain" /></div>
                                        ) : (
                                            <div className={`w-20 h-20 rounded-2xl flex items-center justify-center shadow-sm ${selectedNode.type === 'project' ? (selectedNode.isLead ? 'bg-emerald-900 text-emerald-100' : 'bg-emerald-100 text-emerald-700') : (selectedNode.name.toLowerCase().includes("realitylab") ? 'bg-red-600 text-white' : 'bg-blue-600 text-white')}`}>
                                                {selectedNode.type === 'project' ? <Icon name="briefcase" size={32}/> : <Icon name="building-2" size={32}/>}
                                            </div>
                                        )}
                                        <div>
                                            <h2 className="text-2xl font-black leading-tight text-slate-900">{selectedNode.name}</h2>
                                            <div className="flex items-center gap-2 mt-2">
                                                <span className={`px-2 py-0.5 rounded text-[10px] font-black uppercase tracking-widest ${selectedNode.type === 'project' ? 'bg-emerald-100 text-emerald-700' : 'bg-blue-100 text-blue-700'}`}>{selectedNode.type === 'project' ? 'Forschungsprojekt' : 'Organisation'}</span>
                                                {selectedNode.url && <a href={selectedNode.url.startsWith('http') ? selectedNode.url : `https://${selectedNode.url}`} target="_blank" rel="noopener noreferrer" className="flex items-center gap-1.5 text-indigo-600 text-[10px] font-bold hover:underline bg-indigo-50 px-2 py-0.5 rounded uppercase"><Icon name="globe" size={10}/> Website</a>}
                                            </div>
                                        </div>
                                    </div>
                                    {selectedNode.type === 'project' ? (
                                        <div className="space-y-6">
                                            <div className="grid grid-cols-1 gap-3">
                                                <div className="flex items-center gap-3 text-xs font-bold text-slate-500 bg-slate-50 p-4 rounded-xl border border-slate-100"><Icon name="calendar" size={16}/> Laufzeit: <span className="text-slate-900 ml-auto">{selectedNode.period}</span></div>
                                                <div className="flex flex-col gap-3 bg-slate-50 p-4 rounded-xl border border-slate-100">
                                                    <div className="flex items-center gap-2 text-xs font-bold text-slate-500"><Icon name="file-text" size={16}/> Programm: <span className="text-slate-900 ml-auto">{selectedNode.program}</span></div>
                                                    <div className="flex items-center gap-2 text-xs font-bold text-slate-500"><Icon name="award" size={16}/> Ausschreibung: <span className="text-slate-900 ml-auto">{selectedNode.call}</span></div>
                                                </div>
                                            </div>
                                            <div className="bg-slate-50 p-6 rounded-2xl border border-slate-100 italic text-slate-600 text-sm leading-relaxed">{selectedNode.abstract || "Keine Projektbeschreibung vorhanden."}</div>
                                            <div>
                                                <h4 className="text-[10px] uppercase font-black tracking-widest text-slate-400 mb-4 border-b pb-2 flex justify-between">Projektkonsortium</h4>
                                                <div className="space-y-2">
                                                    {processedLinks.filter(l => l.target === selectedNode.id).map((l, i) => {
                                                        const orgNode = processedNodes.find(n => n.id === l.source);
                                                        return (
                                                            <div key={i} className="flex items-center justify-between p-3 bg-white border border-slate-100 rounded-xl hover:shadow-md transition-shadow">
                                                                <div className="flex items-center gap-3">{orgNode?.logo ? <img src={orgNode.logo} className="w-8 h-8 object-contain" alt="" /> : <Icon name="building-2" size={16}/>} <span className="text-xs font-bold text-slate-700">{orgNode?.name}</span></div>
                                                                <span className={`text-[8px] px-2 py-1 rounded font-black uppercase ${l.role === "Konsortialführer" ? "bg-indigo-600 text-white" : "bg-slate-100 text-slate-400"}`}>{l.role === "Konsortialführer" ? "Lead" : "Partner"}</span>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="space-y-6">
                                            <h4 className="text-[10px] uppercase font-black tracking-widest text-slate-400 mb-4 border-b pb-2">Projektbeteiligungen</h4>
                                            <div className="space-y-3">
                                                {processedLinks.filter(l => l.source === selectedNode.id).map((l, i) => {
                                                    const proj = processedNodes.find(pn => pn.id === l.target);
                                                    if (!proj) return null;
                                                    return (
                                                        <div key={i} className={`p-4 rounded-2xl border flex items-center gap-4 ${proj.isLead ? 'bg-indigo-900 text-white' : 'bg-slate-50 text-slate-900'}`}>
                                                            {proj.logo && <img src={proj.logo} className="w-12 h-12 rounded bg-white p-1 object-contain" alt=""/>}
                                                            <div className="flex-1"><div className="text-sm font-black mb-1">{proj.name}</div><div className="flex items-center gap-3 text-[9px] uppercase font-bold opacity-70"><span>{proj.program}</span><span className="h-1 w-1 bg-current rounded-full"></span><span>{l.role === "Konsortialführer" ? "Lead" : "Partner"}</span></div></div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </aside>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
